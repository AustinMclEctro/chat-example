<!doctype html>
<html>
  <head>
    <title>SENG 513 A3 Web Chat</title>
    <link rel="stylesheet" type="text/css" href="mainStyle.css">
    <meta name="viewport" content="width=device-width, initial-scale=1">
  </head>
  <body>
      
      <div class="WindowHolder">
          
          <div class="Window" id="Chat">
            <h2 id="WelcomeHeading">Welcome</h2>
              <div id="messagesDiv">
                  <ul id="messages"></ul>
              </div>
          </div>
    
          <div class="Window" id="Users">
            <h2 id="UsersHeading">Users</h2>
              <div id="usersDiv">
                  <ul id="usersList"></ul>
              </div>
          </div>
      </div>
      
    <form action="">
      <input id="m" autocomplete="off" /><button>Send</button>
    </form>
      
    <script src="https://cdn.socket.io/socket.io-1.2.0.js"></script>
    <script src="https://code.jquery.com/jquery-1.11.1.js"></script>
    <script>
      $(function () {
        var socket = io();
          
        $("form").submit(function(){
            var m = $("#m").val();
            
            // Check for /nick command
            if(m.slice(0, 5).includes("/nick")){
                var nickname = m.slice(6);
                socket.emit("sendNickname", nickname);
            }
            else{
                var t = "";
                socket.emit("chat message", t, m);
            }
            
            $("#m").val("");
            return false;
        });
          
        socket.on("chat message", function(t, msg, id){
            if(id === socket.id){
                $("#messages").append($("<li id='timestamp'>"+t+"<li><b>"+msg+"</b></li></li>"));
            } else{
                $("#messages").append($("<li id='timestamp'>"+t+"<li>"+msg+"</li></li>"));
            }
            
            // Keep scroll at bottom
            document.getElementById("messagesDiv").scrollTop = document.getElementById("messagesDiv").scrollHeight;
        });
          
        socket.on("refreshUsersList", function(users){
            $("#usersList").empty();
            for(var i = 0; i < users.length; i++){
                $("#usersList").append($("<li>").text(users[i]));
            }
            return false;
        });
          
        socket.on("updateWelcome", function(name){
           $("#WelcomeHeading").text("Welcome "+name);
            return false;
        });
        
        socket.on("updateMessages", function(messages){
            for(var i in messages){
               $("#messages").append($("<li id='timestamp'>"+messages[i]+"<li>"+i+"</li></li>"));
                document.getElementById("messagesDiv").scrollTop = document.getElementById("messagesDiv").scrollHeight;
           }
        });
          
      });
    </script>
  </body>
</html>
